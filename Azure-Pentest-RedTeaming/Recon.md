# Discovery and Recon

# Table of Contents

1. [Discovery and Recon](#discovery-and-recon)
   1. [Discovery and Recon - Azure Tenant](#discovery-and-recon---azure-tenant)
   
   2. [Discovery and Recon - Email IDs](#discovery-and-recon---email-ids)
    
   3. [Discovery and Recon - Azure Services](#discovery-and-recon---azure-services)
   



## Discovery and Recon - Azure Tenant

### Overview
Performing discovery and reconnaissance on the Azure Tenant is crucial for understanding the target environment. This section outlines various techniques and tools for Azure Tenant discovery.

#### Check if Azure Tenant is in Use, Tenant Name, and Federation
- Use the following link to check if the Azure tenant is in use, retrieve the tenant name, and determine federation status.
- Make sure to replace the username and domain.
    ```bash
    https://login.microsoftonline.com/getuserrealm.srf?login=[USERNAME@DOMAIN]&xml=1
    ```

#### Get the Tenant ID
- Retrieve the Azure Tenant ID using the following link:
- make sure to replace the domain name
    ```bash
    https://login.microsoftonline.com/[DOMAIN]/.well-known/openid-configuration
    ```

#### Validate Email ID
- Use the AADInternals tool (https://github.com/Gerenios/AADInternals) for Recon.
  - Import the AADInternals module:
    ```powershell
    Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1 -Verbose
    ```
  - Get tenant name, authentication, brand name (usually same as directory name), and domain name:
    ```powershell
    Get-AADIntLoginInformation -UserName root@demo.onmicrosoft.com
    ```

#### Get Tenant Information
- Use the AADInternals tool for comprehensive information retrieval:
    ```powershell
    # Get tenant ID
    Get-AADIntTenantID -Domain demo.onmicrosoft.com

    # Get tenant domains
    Get-AADIntTenantDomains -Domain demo.onmicrosoft.com
    Get-AADIntTenantDomains -Domain test.onmicrosoft.com
    Get-AADIntTenantDomains -Domain microsoft.com

    # Get all the information
    Invoke-AADIntReconAsOutsider -DomainName defcorphq.onmicrosoft.com
    ```

### Additional Notes
- Validation of Email IDs can be performed by sending requests to:
  ```bash
  https://login.microsoftonline.com/common/GetCredentialType

## Discovery and Recon - Email IDs

### o365creeper
- Utilize [o365creeper](https://github.com/LMGsec/o365creeper) to check if an email ID belongs to a tenant.
  - Make requests to the GetCredentialType API.
    ```bash
    C:\Python27\python.exe C:\AzAD\Tools\o365creeper\o365creeper.py -f C:\AzAD\Tools\emails.txt -o C:\AzAD\Tools\validemails.txt
    ```

### Email Discovery Tools
There are various email enumeration tools available, both free and paid. Here are some personal favorites:

- [Hunter.io](https://hunter.io/)
- [DeHashed](https://www.dehashed.com/)
- [theHarvester](https://github.com/laramies/theHarvester)

### VALIDATING EMAILS - TeamFiltration
[TeamFiltration](https://twitter.com/Flangvik) is a cross-platform framework for enumerating, spraying, exfiltrating, and validating emails. Developed by Flangvik.

#### TeamFiltration Commands
- Enumerate a list of user-provided emails and discover valid emails. Validation uses the Microsoft Teams API.
  ```bash
  TeamFiltration_Win.exe --enum --validate-teams --usernames .\vought-user-emails.txt --outpath .\TF-Demo\ --config .\TeamFiltrationConfig_Example.json
   ```
- Connect to the database.
  ```bash
  TeamFiltration_Win.exe --database --outpath .\TF-Demo\ --config .\TeamFiltrationConfig_Example.json
  ```
- Show collected emails
  ```bash
  show emails
  ```
  ### VALIDATING EMAILS - Omnispray
  [Omnispray](https://github.com/0xZDH/Omnispray)
  - Enumerate a list of user-provided emails and discover valid emails via the Office 365 module.
    ```bash
    python3 omnispray.py --type enum -uf ../Vought-Files/vought-user-emails.txt
    ```

  ## Discovery and Recon - Azure Services

- Azure services are available at specific domains and subdomains.
- We can enumerate if the target organization is using any of the services by looking for such subdomains.
- The tool that we will use for this is [MicroBurst](https://github.com/NetSPI/MicroBurst).
  - MicroBurst is a useful tool for security assessment of Azure. It uses Az, AzureAD, AzurRM, and MSOL tools and additional REST API calls!
  - Import the MicroBurst module:
    ```powershell
    Import-Module C:\AzAD\Tools\MicroBurst\MicroBurst.psm1 -Verbose
    ```
  - Enumerate all subdomains for an organization specified using the '-Base' parameter:
    ```powershell
    Invoke-EnumerateAzureSubDomains -Base defcorphq -Verbose
    ```

### File: Invoke-EnumerateAzureBlobs.ps1
- **Description:** PowerShell function for enumerating public Azure Blob file resources.
- Invoke the function to enumerate Azure Blobs:
  ```powershell
  Invoke-EnumerateAzureBlobs -Base defcorp
  ```

